<!DOCTYPE html>
<html>
    <head>
      <title>
        Simple Coordinate Interactive System
      </title>

      <style>
        body {
          font: 10px sans-serif;
        }

        .axis path,
        .axis line {
          fill: none;
          stroke: #000;
          shape-rendering: crispEdges;
        }

        .cursor {
          fill: none;
          stroke: brown;
          pointer-events: none;
        }
        select.btn {
            -webkit-appearance: button;
               -moz-appearance: button;
                    appearance: button;
            width: auto;
        }

        .dot {
          stroke: #000;
        }
      </style>
      <script src="/static/js/d3.min.js"></script>
      <script src="/static/js/jquery-1.9.1.min.js"></script>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1.0">
      <link href="/static/bootstrap/css/bootstrap.min.css" rel="stylesheet" media="screen">
      <script src="/static/bootstrap/js/bootstrap.min.js"></script>
    </head>
    <body id="main">
      <div class="page-header"><h2>&nbsp;Support Vector Regression Demo <small>based on Shogun-Toolbox</small></h2></div>
      <div class="row">
      <div class="span11" style="display:inline;"></div>
      <div class="span2" style="display:inline;">
      <form name="argument">
          <label> Kernel Function </label>
          <select name="kernel" class="btn">
                <option value="gaus" selected>GaussianKernel</option>
                <option value="poly">PolynomialKernel</option>
                <option value="line">LinearKernel</option>
             </select></br>
          <label> C  </label>
          <input type="text" value="1.0" name="C"></br>
          <label> tube </label>
          <input type="text" value="0.1" name="tube"></br>
          <label>sigma</label>
          <input type="text" value="1.2" name="sigma"></br>
          <label> d </label>
          <input type="text" value="2" name="d">
        <div class="btn-group">
        <button type="button" class="btn btn-small btn-primary"  onclick="regression();">Regression</button>
        <button type="button" class="btn btn-small btn-primary" onclick="clear_map();">Clear</button>
        </div>
      </form>
      </div>
      </div>

      <script>
        var new_points = {"points" : [{"x":6.569, "y":3.289},
        {"x":4.302, "y":1.867}, {"x":1.867, "y":3.378}, {"x":0.551, "y":2.791}]};
        var margin = {top: 20, right: 20, bottom: 30, left: 40},
            width = 800 - margin.left - margin.right,
            height = 500 - margin.top - margin.bottom;

        var x = d3.scale.linear()
            .range([0, width]);

        var y = d3.scale.linear()
            .range([height, 0]);

        var color = d3.scale.category10();

        var xAxis = d3.svg.axis()
            .scale(x)
            .orient("bottom");

        var yAxis = d3.svg.axis()
            .scale(y)
            .orient("left");

        var svg = d3.select(".span11").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .on("mousemove", mousemove)
            .on("mousedown", mousedown)
          .append("g")
            .attr("transform", "translate(" + margin.left + "," +
            margin.top + ")")


        var cursor = svg.append("circle")
            .attr("r", 5)
            .attr("transform", "translate(-100,-100)")
            .attr("class", "cursor");
        
        function mousemove() {
          cursor.attr("transform", "translate(" +
          (d3.mouse(this)[0]-margin.left) +","+
          (d3.mouse(this)[1]-margin.top) +
          ")");
        }
        function mousedown() {
          var point = d3.mouse(this);
          point[0]-=margin.left;
          point[1]-=margin.top;
          svg.append("circle")
            .attr("class",  "dot")
            .attr("r", 2.5)
            .attr("cx", point[0])
            .attr("cy", point[1]);
          new_points.points.push( {"x": x.invert(point[0]).toFixed(3),"y": y.invert(point[1]).toFixed(3)});
        }
        

          new_points.points.forEach(function(d) {
            d.x = +d.x;
            d.y = +d.y;
          });

          x.domain([0,8]).nice();
          y.domain([0,4]).nice();
                   
          svg.append("g")
              .attr("class", "x axis")
              .attr("transform", "translate(0," + height + ")")
              .call(xAxis)
             .append("text")
              .attr("class", "label")
              .attr("x", width)
              .attr("y", -6)
              .style("text-anchor", "end")
              .text("X-axis");

          svg.append("g")
              .attr("class", "y axis")
              .call(yAxis)
             .append("text")
              .attr("class", "label")
              .attr("transform", "rotate(-90)")
              .attr("y", 6)
              .attr("dy", ".71em")
              .style("text-anchor", "end")
              .text("Y-axis");

          svg.selectAll(".dot")
              .data(new_points.points)
            .enter().append("circle")
              .attr("class", "dot")
              .attr("r", 2.5)
              .attr("cx", function(d) { return x(d.x); })
              .attr("cy", function(d) { return y(d.y); })
              .style("fill", "black")


        function clear_map()
        {
           $('.line').fadeOut(800, function() { $(this).remove(); });
//           svg.selectAll(".line").remove();
           svg.selectAll(".dot").remove();
           new_points = {"points" : []};
        }
        
        function regression()
        {
            if (new_points.points.length !=0)
              $.ajax(
                    {
                      url:"point",
                      type: "GET",
                      contentType: "application/json", 
                      dataType: 'text',
                      data: {data: JSON.stringify(new_points),
                             csrfmiddlewaretoken: '3N1Zbm4Avp4kE5U0snM9B4cdzDKueXZO',
                             C: document.argument.C.value,
                             tube: document.argument.tube.value,
                             kernel: document.argument.kernel.value,
                             sigma: document.argument.sigma.value,
                             d: document.argument.d.value},
                      success: function(data){
                                  var json = $.parseJSON(data);
                                  svg.selectAll(".line").remove();
                                  json.forEach(function(d) {
                                      d.x_value = +d.x_value;
                                      d.y_value = +d.y_value;
                                    });
                                 svg.selectAll(".line")
                                   .data(json)
                                   .enter().append("circle")
                                   .attr("class", "line")
                                   .attr("r", 2.5)
                                   .attr("cx", function(d) { return x(d.x_value); })
                                   .attr("cy", function(d) { return y(d.y_value); })
                                   .style("fill", "blue");
        
                               },
        
                      error: function(){
                                   alert("Error Generated!");
                               }
                    });
             else{
                  alert("Sorry, there's no dot input, click some, pls");
             }
        }

        
        </script>
    </body>
</html>
